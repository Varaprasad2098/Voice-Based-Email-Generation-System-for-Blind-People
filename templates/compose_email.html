<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voice Compose Email</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: url("https://img.freepik.com/premium-photo/mail-envelope-binary-code-abstract-technology-background-with_1089026-7109.jpg?uid=R192116025&ga=GA1.1.859646711.1727881514&semt=ais_hybrid&w=740") no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      color: white;
    }
    .card-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 20px;
      max-width: 600px;
      margin: 80px auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }
    label {
      font-weight: bold;
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
  </style>
</head>
<body>
  <div class="card-container">
    <h2>Compose Email by Voice</h2>
    <a href="/dashboard" class="btn btn-light mb-3">‚Üê Back to Dashboard</a>

    <form method="POST" id="compose-form">
      <div class="form-group mb-3">
        <label for="recipient">Recipient Email:</label>
        <input type="text" class="form-control" id="recipient" name="recipient" readonly required />
      </div>

      <div class="form-group mb-3">
        <label for="subject">Subject:</label>
        <input type="text" class="form-control" id="subject" name="subject" readonly required />
      </div>

      <div class="form-group mb-3">
        <label for="body">Message:</label>
        <textarea class="form-control" id="body" name="body" rows="5" readonly required></textarea>
      </div>

      <button type="button" class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2" onclick="startVoiceCompose()">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" alt="Mic Icon" style="width: 20px; height: 20px;" />
        Start Voice Compose
      </button>
    </form>
  </div>

  <script>
    const synth = window.speechSynthesis;
    let recognition;

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;
    } else {
      alert("Your browser does not support Speech Recognition.");
    }

    function speak(text, callback = null) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.onend = () => setTimeout(() => callback && callback(), 600); // short pause
      synth.speak(utter);
    }

    function listen(callback) {
      if (!recognition) return;

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript.trim();
        recognition.stop();
        callback(transcript);
      };

      recognition.onerror = function () {
        recognition.stop();
        speak("Sorry, I didn't catch that. Let's try again.", () => listen(callback));
      };

      recognition.start();
    }

    function cleanEmail(text) {
      return text
        .replace(/\s+at\s+the\s+rate\s+/gi, "@")
        .replace(/\s+at\s+/gi, "@")
        .replace(/\s+dot\s+/gi, ".")
        .replace(/\s+underscore\s+/gi, "_")
        .replace(/\s+dash\s+/gi, "-")
        .replace(/\s+comma\s+/gi, ",")
        .replace(/\s+/g, "");
    }

    function isConfirmation(response) {
      return /^(yes|yeah|correct|right|true)$/i.test(response);
    }

    function resetAllFields() {
      document.getElementById("recipient").value = "";
      document.getElementById("subject").value = "";
      document.getElementById("body").value = "";
    }

    function startVoiceCompose() {
      resetAllFields();
      getRecipient(0);
    }

    function getRecipient(attempts) {
      if (attempts > 2) return speak("Too many failed attempts. Restarting.", startVoiceCompose);

      speak("Please say the recipient email.", () => {
        setTimeout(() => {
          listen((input) => {
            const email = cleanEmail(input);
            document.getElementById("recipient").value = email;
            speak(`You said ${email}. Say yes, correct, or true to confirm.`, () => {
              setTimeout(() => {
                listen((confirm) => {
                  if (isConfirmation(confirm)) {
                    getSubject(0);
                  } else {
                    speak("Let's try the recipient again.", () => getRecipient(attempts + 1));
                  }
                });
              }, 2500);
            });
          });
        }, 6000);
      });
    }

    function getSubject(attempts) {
      if (attempts > 2) return speak("Too many failed attempts. Restarting.", startVoiceCompose);

      speak("Please say the subject of the email.", () => {
        setTimeout(() => {
          listen((subject) => {
            document.getElementById("subject").value = subject;
            speak(`Subject is: ${subject}. Say yes, correct, or true to confirm.`, () => {
              setTimeout(() => {
                listen((confirm) => {
                  if (isConfirmation(confirm)) {
                    getBody(0);
                  } else {
                    speak("Let's try the subject again.", () => getSubject(attempts + 1));
                  }
                });
              }, 2500);
            });
          });
        }, 6000);
      });
    }

    function getBody(attempts) {
      if (attempts > 2) return speak("Too many failed attempts. Restarting.", startVoiceCompose);

      speak("Now please say the body of the message.", () => {
        setTimeout(() => {
          listen((body) => {
            document.getElementById("body").value = body;
            speak(`You said: ${body}. Say yes, correct, or true to confirm.`, () => {
              setTimeout(() => {
                listen((confirm) => {
                  if (isConfirmation(confirm)) {
                    confirmSend();
                  } else {
                    speak("Let's try the message again.", () => getBody(attempts + 1));
                  }
                });
              }, 2500);
            });
          });
        }, 6000);
      });
    }

    function confirmSend() {
      speak("Do you want to send the mail? Say send, yes, correct, or true to confirm. Or say cancel to restart.", () => {
        setTimeout(() => {
          listen((response) => {
            if (/^(send|yes|correct|true|confirm)$/i.test(response)) {
              speak("Sending your email now.", () => {
                document.getElementById("compose-form").submit();
              });
            } else {
              speak("Okay, restarting the process.", startVoiceCompose);
            }
          });
        }, 2500);
      });
    }

    window.onload = function () {
      {% if mail_sent %}
      speak("Your mail has been sent successfully.");
      {% endif %}
    }
  </script>
</body>
</html>
